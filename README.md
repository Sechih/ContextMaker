# ContextMaker

**ContextMaker** — настольное Qt‑приложение (Qt Widgets), которое формирует **Markdown‑отчёт по выбранному каталогу**:

1) дерево каталогов/файлов  
2) содержимое файлов по фильтрам (расширения/лимиты/исключения)

Подходит для подготовки «контекста» проекта: для ревью, аудита, пересылки коллегам, вставки в LLM и т.п.

---

## Возможности

### 1) Дерево каталога
- Встроенная генерация дерева (Unicode псевдографика `├──/└──`).
- (Windows) опционально — дерево через `cmd` командой `tree /F /A` (чекбокс в UI).

### 2) Содержимое файлов (секция 2)
- Выводит только файлы, расширения которых есть в *IncludeExt*.
- Не читает файлы больше *MaxBytes*.
- Лимитирует вывод текста на файл параметром *MaxOutChars* (можно поставить `0` = без лимита).
- Список исключаемых каталогов (*Exclude dirs*) — пропускаются целиком на любом уровне.

### Поддерживаемые форматы
- ✅ Текстовые файлы: авто‑детект BOM, строгий UTF‑8, fallback ANSI (system)  
  + режим «принудительно ANSI» для файлов без BOM
- ✅ **PDF** → текст через внешнюю утилиту `pdftotext.exe` (Poppler)
- ✅ **DOCX** → извлечение текста  
  *(Windows: распаковка через PowerShell `Expand-Archive` + парсинг `word/document.xml`)*
- ✅ **XLSX/XLSM** → извлечение таблиц в TSV‑подобный текст  
  *(Windows: распаковка через PowerShell `Expand-Archive` + парсинг XML)*
- ⚠️ **DOC** и **XLS**: выводится пояснение (извлечение не реализовано)

### Удобство
- Генерация отчёта в фоне (QtConcurrent) + диалог прогресса + **Отмена**.
- Просмотр в `QTextEdit` как Markdown.
- Контекстное меню: копировать выделение / копировать весь Markdown.
- Сохранение отчёта в файл (UTF‑8 с BOM, удобно для Windows/Notepad).

---

## Требования

### Для сборки
- **CMake ≥ 3.16**
- **C++17**
- **Qt 6** (Widgets + Concurrent)  
  *(С Qt 5 проект тоже собирается, но автоматический deploy‑скрипт из CMake — именно под Qt 6.)*

### Для запуска
- Windows 10/11 (основная целевая платформа).
- Для чтения **DOCX/XLSX/XLSM** на Windows нужен `powershell.exe` и cmdlet `Expand-Archive`.
- Для чтения **PDF** нужен `pdftotext.exe`:
  - либо рядом с приложением (рекомендовано для portable),
  - либо установлен в системе и доступен из `PATH`.

---

## Использование

1. Запустить `ContextMaker.exe`
2. Нажать **Открыть** → выбрать корневую папку
3. Настроить параметры (при необходимости):
   - **Ограничение размера файла при сборке** (*MaxBytes*)
   - **Лимит текста в отчёте (на 1 файл)** (*MaxOutChars*, `0` = без лимита)
   - **Список расширений** (*IncludeExt*)
   - **Исключить каталоги** (*Exclude dirs*)
   - (Windows) **Формат: tree /F /A (cmd)** — если нужен вывод дерева стандартной утилитой Windows
   - **Только дерево** — без секции с содержимым
   - **Кодировка без BOM** — Auto (BOM→UTF‑8→ANSI) или «Принудительно ANSI»
4. Нажать **Собрать отчёт**
5. При необходимости:
   - **Сохранить** отчёт в `.md`
   - ПКМ → копировать / копировать Markdown

---

## Сборка (CMake)

```bash
cmake -S . -B build
cmake --build build --config Release
```

---

## Deploy (Windows, Qt 6)

В проекте есть цель `deploy`, которая делает `cmake --install ...` в префикс деплоя.

### Быстрый деплой в папку `deploy/` рядом с проектом
```bash
cmake --build build --config Release --target deploy
```

По умолчанию итог будет в:

```
<project_root>/deploy/
└─ bin/
   ├─ ContextMaker.exe
   ├─ Qt*.dll ...
   └─ tools/ ...
```

> Путь деплоя можно менять через CMake cache‑переменную `APP_DEPLOY_PREFIX`.

---

## PDF: Poppler (pdftotext.exe)

Для извлечения текста из PDF используется **внешняя консольная утилита** `pdftotext.exe` из проекта **Poppler**.

### Рекомендованный релиз Poppler for Windows
Используется сборка Poppler для Windows из репозитория `poppler-windows`:

- https://github.com/oschwartz10612/poppler-windows/releases/tag/v25.12.0-0

### Куда положить `pdftotext.exe`
Приложение ищет `pdftotext.exe` в следующем порядке:
1) рядом с `.exe` (редко используется)
2) `tools/poppler/pdftotext.exe` (рекомендуемый вариант для portable деплоя)
3) `poppler/pdftotext.exe`
4) в `PATH`

**Рекомендуемая структура рядом с `ContextMaker.exe`:**
```
bin/
  ContextMaker.exe
  tools/
    poppler/
      pdftotext.exe
      *.dll
```

### Как подготовить Poppler из релиза
1) Скачать архив релиза `v25.12.0-0`
2) Распаковать
3) Найти `pdftotext.exe` (обычно находится в `Library\bin\`)
4) Скопировать **`pdftotext.exe` и все нужные `.dll` из той же папки** в:
   - `<project_root>/tools/poppler/` (чтобы CMake install/deploy перенёс их в релиз)
   - либо сразу в `<deploy_prefix>/bin/tools/poppler/` (для готового portable релиза)

> В CMake уже добавлено копирование папки `tools` в `bin` при `cmake --install`, поэтому для релиза достаточно держать `tools/` в корне проекта.

---

## Примечания и ограничения

- **DOCX/XLSX/XLSM** сейчас реализованы через PowerShell распаковку (Windows‑only).
- Если в системе запрещён запуск PowerShell/Expand‑Archive (политики, антивирус, sandbox) — эти форматы могут не извлекаться.
- PDF‑парсинг зависит от качества `pdftotext` и структуры PDF (сканы без OCR дадут «пусто» или мусор).

---

## Troubleshooting

### “Не найден pdftotext.exe”
- Проверьте наличие файла: `bin/tools/poppler/pdftotext.exe`
- Убедитесь, что рядом лежат DLL‑зависимости (если `pdftotext.exe` не запускается вручную — значит не хватает DLL)
- Альтернатива: установите `pdftotext` в систему и добавьте в `PATH`

### Ошибка извлечения DOCX/XLSX (Expand-Archive)
- Проверьте, что `powershell.exe` доступен
- Проверьте, что файлы не заблокированы (Mark of the Web), и есть права на временные папки

### Команда tree выдаёт ошибку
- Отключите опцию “Формат: tree /F /A (cmd)” — приложение перейдёт на встроенное дерево

---

## Лицензии и сторонние компоненты

Проект использует сторонние компоненты. При распространении релиза учитывайте их лицензии:

- **Qt**: лицензия зависит от вашей поставки (Open Source LGPL / Commercial).
- **Poppler/pdftotext**: лицензия Poppler — GPL (при распространении `pdftotext.exe` и DLL соблюдайте требования лицензии Poppler).
- Репозиторий **poppler-windows** — это упаковка/сборка Poppler под Windows, распространяющая готовые бинарники.

> Если вы делаете публичный релиз — добавьте в релиз файлы лицензий (Qt + Poppler) и/или ссылку на исходники/условия распространения согласно требованиям этих лицензий.
